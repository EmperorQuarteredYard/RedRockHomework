<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>选课 - 选课系统</title>
    <link rel="stylesheet" href="/static/css/common.css">
    <link rel="stylesheet" href="/static/css/table.css">
</head>
<body>
<div class="header">
    <div class="logo">选课系统 - 学生后台</div>
    <div class="user-info">
        <span id="studentName">学生</span>
        <button class="btn btn-secondary" onclick="logout()">退出登录</button>
    </div>
</div>

<div class="container">
    <nav style="margin-bottom: 20px;">
        <a href="/student/lessons" class="btn btn-primary">选课中心</a>
        <a href="/student/my-lessons" class="btn btn-secondary">我的课程</a>
    </nav>

    <div class="table-toolbar">
        <h2>可选课程列表</h2>
        <div class="search-box">
            <input type="text" placeholder="搜索课程..." id="searchInput">
        </div>
    </div>

    <div class="table-container">
        <table class="table" id="lessonTable">
            <thead>
            <tr>
                <th data-sort="code">课程代码</th>
                <th data-sort="name">课程名称</th>
                <th data-sort="credit">学分</th>
                <th data-sort="capacity">容量</th>
                <th data-sort="duration">上课时间</th>
                <th data-sort="description">课程描述</th>
                <th>操作</th>
            </tr>
            </thead>
            <tbody>
            <!-- 数据将通过JS动态填充 -->
            </tbody>
        </table>
    </div>

    <div class="pagination" id="pagination"></div>
</div>

<script src="/static/js/common.js"></script>
<script src="/static/js/table.js"></script>
<script>
    let lessonTable;
    let selectedLessons = [];
    let allLessons = [];
    let currentPage = 1;
    const pageSize = 8;

    // 初始化
    document.addEventListener('DOMContentLoaded', function() {
        // 检查登录状态
        if (!Auth.isAuthenticated() || Auth.getUserRole() !== 'student') {
            window.location.href = '/login';
            return;
        }

        initTable();
        loadAllLessons();
        loadSelectedLessons();
        setupSearch();
    });

    function initTable() {
        lessonTable = document.getElementById('lessonTable');
    }

    async function loadAllLessons() {
        try {
            UI.showLoading();
            const response = await API.get('/api/lessons');

            if (response && response.data) {
                allLessons = response.data;
                renderLessons();
            }
        } catch (error) {
            console.error('加载课程失败:', error);
        } finally {
            UI.hideLoading();
        }
    }

    async function loadSelectedLessons() {
        try {
            const response = await API.get('/api/lessons/selected');

            if (response && response.data) {
                selectedLessons = response.data;
                updateSelectedStatus();
            }
        } catch (error) {
            console.error('加载已选课程失败:', error);
        }
    }

    function renderLessons() {
        const tbody = lessonTable.querySelector('tbody');
        tbody.innerHTML = '';

        const startIndex = (currentPage - 1) * pageSize;
        const endIndex = startIndex + pageSize;
        const pageLessons = allLessons.slice(startIndex, endIndex);

        pageLessons.forEach(lesson => {
            const isSelected = selectedLessons.some(selected => selected.id === lesson.id);
            const isFull = lesson.capacity <= getSelectedCount(lesson.id);

            const row = document.createElement('tr');
            row.innerHTML = `
                    <td>${lesson.code || ''}</td>
                    <td>${lesson.name || ''}</td>
                    <td>${lesson.credit || ''}</td>
                    <td>${lesson.capacity || ''}</td>
                    <td>${lesson.duration || ''}</td>
                    <td>${lesson.description || ''}</td>
                    <td>
                        ${isSelected ?
                `<button class="btn btn-danger btn-sm" onclick="dropLesson(${lesson.id})">退选</button>` :
                `<button class="btn btn-success btn-sm" onclick="selectLesson(${lesson.id})" ${isFull ? 'disabled' : ''}>选课</button>`
            }
                    </td>
                `;

            tbody.appendChild(row);
        });

        renderPagination();
    }

    function getSelectedCount(lessonId) {
        // 这里应该从服务器获取实际选课人数
        return selectedLessons.filter(lesson => lesson.id === lessonId).length;
    }

    function updateSelectedStatus() {
        const rows = lessonTable.querySelectorAll('tbody tr');
        rows.forEach(row => {
            const lessonId = parseInt(row.cells[6].querySelector('button').onclick.toString().match(/\d+/)[0]);
            const isSelected = selectedLessons.some(lesson => lesson.id === lessonId);
            const buttonCell = row.cells[6];

            if (isSelected) {
                buttonCell.innerHTML = `<button class="btn btn-danger btn-sm" onclick="dropLesson(${lessonId})">退选</button>`;
            } else {
                buttonCell.innerHTML = `<button class="btn btn-success btn-sm" onclick="selectLesson(${lessonId})">选课</button>`;
            }
        });
    }

    async function selectLesson(lessonId) {
        try {
            UI.showLoading();

            // 获取当前学生ID（这里需要根据实际情况调整）
            const user = await API.get('/api/user');
            const studentId = user ? user.id : 1;

            const response = await API.post('/api/lessons/select', {
                student_id: studentId,
                lesson_id: lessonId
            });

            if (response && response.success) {
                UI.showMessage('选课成功');
                selectedLessons.push(allLessons.find(lesson => lesson.id === lessonId));
                updateSelectedStatus();
            }
        } catch (error) {
            console.error('选课失败:', error);
        } finally {
            UI.hideLoading();
        }
    }

    async function dropLesson(lessonId) {
        try {
            UI.showLoading();

            // 获取当前学生ID（这里需要根据实际情况调整）
            const user = await API.get('/api/user');
            const studentId = user ? user.id : 1;

            const response = await API.post('/api/lessons/drop', {
                student_id: studentId,
                lesson_id: lessonId
            });

            if (response && response.success) {
                UI.showMessage('退选成功');
                selectedLessons = selectedLessons.filter(lesson => lesson.id !== lessonId);
                updateSelectedStatus();
            }
        } catch (error) {
            console.error('退选失败:', error);
        } finally {
            UI.hideLoading();
        }
    }

    function setupSearch() {
        const searchInput = document.getElementById('searchInput');
        searchInput.addEventListener('input', debounce(function() {
            const keyword = this.value.toLowerCase();

            if (!keyword) {
                renderLessons();
                return;
            }

            const filtered = allLessons.filter(lesson =>
                (lesson.code && lesson.code.toLowerCase().includes(keyword)) ||
                (lesson.name && lesson.name.toLowerCase().includes(keyword)) ||
                (lesson.description && lesson.description.toLowerCase().includes(keyword))
            );

            const tbody = lessonTable.querySelector('tbody');
            tbody.innerHTML = '';

            filtered.forEach(lesson => {
                const isSelected = selectedLessons.some(selected => selected.id === lesson.id);

                const row = document.createElement('tr');
                row.innerHTML = `
                        <td>${lesson.code || ''}</td>
                        <td>${lesson.name || ''}</td>
                        <td>${lesson.credit || ''}</td>
                        <td>${lesson.capacity || ''}</td>
                        <td>${lesson.duration || ''}</td>
                        <td>${lesson.description || ''}</td>
                        <td>
                            ${isSelected ?
                    `<button class="btn btn-danger btn-sm" onclick="dropLesson(${lesson.id})">退选</button>` :
                    `<button class="btn btn-success btn-sm" onclick="selectLesson(${lesson.id})">选课</button>`
                }
                        </td>
                    `;

                tbody.appendChild(row);
            });
        }, 300));
    }

    function renderPagination() {
        const totalPages = Math.ceil(allLessons.length / pageSize);
        if (totalPages <= 1) {
            document.getElementById('pagination').innerHTML = '';
            return;
        }

        let paginationHTML = '';

        if (currentPage > 1) {
            paginationHTML += `<button class="page-item" onclick="changePage(${currentPage - 1})">上一页</button>`;
        }

        for (let i = 1; i <= totalPages; i++) {
            if (i === currentPage) {
                paginationHTML += `<button class="page-item active">${i}</button>`;
            } else if (i <= 3 || i >= totalPages - 2 || Math.abs(i - currentPage) <= 1) {
                paginationHTML += `<button class="page-item" onclick="changePage(${i})">${i}</button>`;
            } else if (paginationHTML.slice(-1) !== '...') {
                paginationHTML += `<span class="page-item">...</span>`;
            }
        }

        if (currentPage < totalPages) {
            paginationHTML += `<button class="page-item" onclick="changePage(${currentPage + 1})">下一页</button>`;
        }

        document.getElementById('pagination').innerHTML = paginationHTML;
    }

    function changePage(page) {
        currentPage = page;
        renderLessons();
        window.scrollTo(0, 0);
    }

    function logout() {
        Auth.clearTokens();
        window.location.href = '/login';
    }

    // 暴露函数到全局
    window.selectLesson = selectLesson;
    window.dropLesson = dropLesson;
    window.changePage = changePage;
    window.logout = logout;
</script>
</body>
</html>