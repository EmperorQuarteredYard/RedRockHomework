<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>学生管理 - 选课系统</title>
    <link rel="stylesheet" href="/static/css/common.css">
    <link rel="stylesheet" href="/static/css/table.css">
</head>
<body>
<div class="header">
    <div class="logo">选课系统 - 管理员后台</div>
    <div class="user-info">
        <span>管理员</span>
        <button class="btn btn-secondary" onclick="logout()">退出登录</button>
    </div>
</div>

<div class="container">
    <nav style="margin-bottom: 20px;">
        <a href="/admin/lessons" class="btn btn-secondary">课程管理</a>
        <a href="/admin/students" class="btn btn-primary">学生管理</a>
        <a href="/admin/selections" class="btn btn-secondary">选课管理</a>
    </nav>

    <div class="table-toolbar">
        <h2>学生管理</h2>
        <button class="btn btn-success" onclick="openAddStudentModal()">添加学生</button>
    </div>

    <div class="table-container">
        <table class="table" id="studentTable">
            <thead>
            <tr>
                <th data-sort="id" data-field="id">学号</th>
                <th data-sort="name" data-field="name">姓名</th>
                <th data-sort="created_at" data-field="created_at">创建时间</th>
                <th data-sort="updated_at" data-field="updated_at">更新时间</th>
                <th>操作</th>
            </tr>
            </thead>
            <tbody>
            <!-- 数据将通过JS动态填充 -->
            </tbody>
        </table>
    </div>
</div>

<!-- 添加/编辑学生模态框 -->
<div id="studentModal" class="modal">
    <div class="modal-content">
        <div class="modal-header">
            <h3 id="modalTitle">添加学生</h3>
            <span class="close" onclick="Modal.close()">&times;</span>
        </div>
        <div class="modal-body">
            <form id="studentForm">
                <input type="hidden" id="studentId">

                <div class="form-group">
                    <label for="studentName">姓名 *</label>
                    <input type="text" id="studentName" name="name" required>
                </div>

                <div style="text-align: right; margin-top: 20px;">
                    <button type="button" class="btn btn-secondary" onclick="Modal.close()">取消</button>
                    <button type="submit" class="btn btn-primary">保存</button>
                </div>
            </form>
        </div>
    </div>
</div>

<script src="/static/js/common.js"></script>
<script src="/static/js/table.js"></script>
<script>
    let studentTable;
    let editingStudentId = null;

    // 初始化
    document.addEventListener('DOMContentLoaded', function() {
        // 检查登录状态
        if (!Auth.isAuthenticated() || Auth.getUserRole() !== 'admin') {
            window.location.href = '/login';
            return;
        }

        initTable();
        loadStudents();
    });

    function initTable() {
        studentTable = new DataTable('studentTable', {
            searchable: true,
            pagination: true,
            pageSize: 10,
            sortable: true
        });
    }

    async function loadStudents() {
        try {
            UI.showLoading();
            const response = await API.get('/api/students');

            if (response && response.students) {
                const data = response.students.map(student => ({
                    ...student,
                    actions: TableFormatters.actions(
                        student.id,
                        'editStudent',
                        'deleteStudent'
                    )
                }));

                studentTable.setData(data);
            }
        } catch (error) {
            console.error('加载学生失败:', error);
        } finally {
            UI.hideLoading();
        }
    }

    function openAddStudentModal() {
        editingStudentId = null;
        document.getElementById('modalTitle').textContent = '添加学生';
        document.getElementById('studentForm').reset();
        document.getElementById('studentId').value = '';
        document.getElementById('studentModal').style.display = 'block';
    }

    function openEditStudentModal(student) {
        editingStudentId = student.id;
        document.getElementById('modalTitle').textContent = '编辑学生';
        document.getElementById('studentId').value = student.id;
        document.getElementById('studentName').value = student.name || '';
        document.getElementById('studentModal').style.display = 'block';
    }

    document.getElementById('studentForm').addEventListener('submit', async function(e) {
        e.preventDefault();

        const formData = {
            name: document.getElementById('studentName').value
        };

        try {
            UI.showLoading();

            if (editingStudentId) {
                // 编辑学生
                await API.put(`/api/students/${editingStudentId}`, formData);
                UI.showMessage('学生信息更新成功');
            } else {
                // 添加学生
                await API.post('/api/students', formData);
                UI.showMessage('学生添加成功');
            }

            Modal.close();
            loadStudents();
        } catch (error) {
            console.error('保存学生信息失败:', error);
        } finally {
            UI.hideLoading();
        }
    });

    function editStudent(id) {
        const student = studentTable.data.find(item => item.id === id);
        if (student) {
            openEditStudentModal(student);
        }
    }

    function deleteStudent(id) {
        UI.confirm('确定要删除这个学生吗？', async () => {
            try {
                UI.showLoading();
                await API.delete(`/api/students/${id}`);
                UI.showMessage('学生删除成功');
                loadStudents();
            } catch (error) {
                console.error('删除学生失败:', error);
            } finally {
                UI.hideLoading();
            }
        });
    }

    function logout() {
        Auth.clearTokens();
        window.location.href = '/login';
    }

    // 暴露函数到全局
    window.editStudent = editStudent;
    window.deleteStudent = deleteStudent;
    window.openAddStudentModal = openAddStudentModal;
    window.logout = logout;
</script>
</body>
</html>