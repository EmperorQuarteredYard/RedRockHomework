<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>我的课程 - 选课系统</title>
    <link rel="stylesheet" href="/static/css/common.css">
    <link rel="stylesheet" href="/static/css/table.css">
</head>
<body>
<div class="header">
    <div class="logo">选课系统 - 学生后台</div>
    <div class="user-info">
        <span id="studentName">学生</span>
        <button class="btn btn-secondary" onclick="logout()">退出登录</button>
    </div>
</div>

<div class="container">
    <nav style="margin-bottom: 20px;">
        <a href="/student/lessons" class="btn btn-secondary">选课中心</a>
        <a href="/student/my-lessons" class="btn btn-primary">我的课程</a>
    </nav>

    <div class="table-toolbar">
        <h2>我的课程列表</h2>
        <div class="search-box">
            <input type="text" placeholder="搜索课程..." id="searchInput">
        </div>
    </div>

    <div class="summary-cards" style="display: grid; grid-template-columns: repeat(auto-fit, minmax(250px, 1fr)); gap: 20px; margin-bottom: 20px;">
        <div class="card" style="background: white; border-radius: 8px; padding: 20px; box-shadow: 0 2px 4px rgba(0,0,0,0.1);">
            <h3 style="color: #666; font-size: 14px; margin-bottom: 10px;">已选课程</h3>
            <div style="font-size: 32px; font-weight: bold; color: #3498db;" id="totalCourses">0</div>
        </div>
        <div class="card" style="background: white; border-radius: 8px; padding: 20px; box-shadow: 0 2px 4px rgba(0,0,0,0.1);">
            <h3 style="color: #666; font-size: 14px; margin-bottom: 10px;">总学分</h3>
            <div style="font-size: 32px; font-weight: bold; color: #2ecc71;" id="totalCredits">0</div>
        </div>
        <div class="card" style="background: white; border-radius: 8px; padding: 20px; box-shadow: 0 2px 4px rgba(0,0,0,0.1);">
            <h3 style="color: #666; font-size: 14px; margin-bottom: 10px;">课程表</h3>
            <div style="font-size: 16px; color: #666;">查看我的课程安排</div>
            <button class="btn btn-primary btn-sm" style="margin-top: 10px;" onclick="viewSchedule()">查看课表</button>
        </div>
    </div>

    <div class="table-container">
        <table class="table" id="myLessonTable">
            <thead>
            <tr>
                <th data-sort="code">课程代码</th>
                <th data-sort="name">课程名称</th>
                <th data-sort="credit">学分</th>
                <th data-sort="duration">上课时间</th>
                <th data-sort="description">课程描述</th>
                <th data-sort="selected_at">选课时间</th>
                <th>操作</th>
            </tr>
            </thead>
            <tbody>
            <!-- 数据将通过JS动态填充 -->
            </tbody>
        </table>
    </div>

    <div class="pagination" id="pagination"></div>
</div>

<!-- 课程表模态框 -->
<div id="scheduleModal" class="modal">
    <div class="modal-content" style="max-width: 800px;">
        <div class="modal-header">
            <h3>我的课程表</h3>
            <span class="close" onclick="Modal.close()">&times;</span>
        </div>
        <div class="modal-body">
            <div id="scheduleContainer">
                <!-- 课程表将通过JS动态生成 -->
            </div>
        </div>
    </div>
</div>

<script src="/static/js/common.js"></script>
<script src="/static/js/table.js"></script>
<script>
    let myLessonTable;
    let myLessons = [];
    let currentPage = 1;
    const pageSize = 8;

    // 初始化
    document.addEventListener('DOMContentLoaded', function() {
        // 检查登录状态
        if (!Auth.isAuthenticated() || Auth.getUserRole() !== 'student') {
            window.location.href = '/login';
            return;
        }

        initTable();
        loadMyLessons();
        setupSearch();
    });

    function initTable() {
        myLessonTable = document.getElementById('myLessonTable');
    }

    async function loadMyLessons() {
        try {
            UI.showLoading();
            const response = await API.get('/api/lessons/selected');

            if (response && response.data) {
                myLessons = response.data;
                updateSummary();
                renderMyLessons();
            }
        } catch (error) {
            console.error('加载我的课程失败:', error);
        } finally {
            UI.hideLoading();
        }
    }

    function updateSummary() {
        const totalCourses = myLessons.length;
        const totalCredits = myLessons.reduce((sum, lesson) => sum + (lesson.credit || 0), 0);

        document.getElementById('totalCourses').textContent = totalCourses;
        document.getElementById('totalCredits').textContent = totalCredits;
    }

    function renderMyLessons() {
        const tbody = myLessonTable.querySelector('tbody');
        tbody.innerHTML = '';

        const startIndex = (currentPage - 1) * pageSize;
        const endIndex = startIndex + pageSize;
        const pageLessons = myLessons.slice(startIndex, endIndex);

        pageLessons.forEach(lesson => {
            const row = document.createElement('tr');
            row.innerHTML = `
                    <td>${lesson.code || ''}</td>
                    <td>${lesson.name || ''}</td>
                    <td>${lesson.credit || ''}</td>
                    <td>${lesson.duration || ''}</td>
                    <td>${lesson.description || ''}</td>
                    <td>${UI.formatDate(lesson.created_at)}</td>
                    <td>
                        <button class="btn btn-danger btn-sm" onclick="dropLesson(${lesson.id})">退选</button>
                    </td>
                `;

            tbody.appendChild(row);
        });

        renderPagination();
    }

    async function dropLesson(lessonId) {
        UI.confirm('确定要退选这门课程吗？', async () => {
            try {
                UI.showLoading();

                // 获取当前学生ID（这里需要根据实际情况调整）
                const user = await API.get('/api/user');
                const studentId = user ? user.id : 1;

                const response = await API.post('/api/lessons/drop', {
                    student_id: studentId,
                    lesson_id: lessonId
                });

                if (response && response.success) {
                    UI.showMessage('退选成功');
                    myLessons = myLessons.filter(lesson => lesson.id !== lessonId);
                    updateSummary();
                    renderMyLessons();
                }
            } catch (error) {
                console.error('退选失败:', error);
            } finally {
                UI.hideLoading();
            }
        });
    }

    function setupSearch() {
        const searchInput = document.getElementById('searchInput');
        searchInput.addEventListener('input', debounce(function() {
            const keyword = this.value.toLowerCase();

            if (!keyword) {
                renderMyLessons();
                return;
            }

            const filtered = myLessons.filter(lesson =>
                (lesson.code && lesson.code.toLowerCase().includes(keyword)) ||
                (lesson.name && lesson.name.toLowerCase().includes(keyword)) ||
                (lesson.description && lesson.description.toLowerCase().includes(keyword))
            );

            const tbody = myLessonTable.querySelector('tbody');
            tbody.innerHTML = '';

            filtered.forEach(lesson => {
                const row = document.createElement('tr');
                row.innerHTML = `
                        <td>${lesson.code || ''}</td>
                        <td>${lesson.name || ''}</td>
                        <td>${lesson.credit || ''}</td>
                        <td>${lesson.duration || ''}</td>
                        <td>${lesson.description || ''}</td>
                        <td>${UI.formatDate(lesson.created_at)}</td>
                        <td>
                            <button class="btn btn-danger btn-sm" onclick="dropLesson(${lesson.id})">退选</button>
                        </td>
                    `;

                tbody.appendChild(row);
            });
        }, 300));
    }

    function renderPagination() {
        const totalPages = Math.ceil(myLessons.length / pageSize);
        if (totalPages <= 1) {
            document.getElementById('pagination').innerHTML = '';
            return;
        }

        let paginationHTML = '';

        if (currentPage > 1) {
            paginationHTML += `<button class="page-item" onclick="changePage(${currentPage - 1})">上一页</button>`;
        }

        for (let i = 1; i <= totalPages; i++) {
            if (i === currentPage) {
                paginationHTML += `<button class="page-item active">${i}</button>`;
            } else if (i <= 3 || i >= totalPages - 2 || Math.abs(i - currentPage) <= 1) {
                paginationHTML += `<button class="page-item" onclick="changePage(${i})">${i}</button>`;
            } else if (paginationHTML.slice(-1) !== '...') {
                paginationHTML += `<span class="page-item">...</span>`;
            }
        }

        if (currentPage < totalPages) {
            paginationHTML += `<button class="page-item" onclick="changePage(${currentPage + 1})">下一页</button>`;
        }

        document.getElementById('pagination').innerHTML = paginationHTML;
    }

    function changePage(page) {
        currentPage = page;
        renderMyLessons();
        window.scrollTo(0, 0);
    }

    function viewSchedule() {
        const scheduleModal = document.getElementById('scheduleModal');
        const scheduleContainer = document.getElementById('scheduleContainer');

        // 生成课程表
        const timeSlots = ['08:00-10:00', '10:10-12:10', '14:00-16:00', '16:10-18:10', '19:00-21:00'];
        const weekDays = ['周一', '周二', '周三', '周四', '周五', '周六', '周日'];

        let scheduleHTML = `
                <style>
                    .schedule-table {
                        width: 100%;
                        border-collapse: collapse;
                        font-size: 12px;
                    }
                    .schedule-table th, .schedule-table td {
                        border: 1px solid #ddd;
                        padding: 8px;
                        text-align: center;
                        height: 60px;
                        vertical-align: top;
                    }
                    .schedule-table th {
                        background-color: #f8f9fa;
                        font-weight: 600;
                    }
                    .schedule-table .time-cell {
                        background-color: #f1f8ff;
                        font-weight: 500;
                    }
                    .schedule-table .lesson-cell {
                        background-color: #e3f2fd;
                        border-radius: 4px;
                        padding: 4px;
                        margin: 2px;
                        font-size: 11px;
                    }
                </style>
                <table class="schedule-table">
                    <thead>
                        <tr>
                            <th>时间</th>
                            ${weekDays.map(day => `<th>${day}</th>`).join('')}
                        </tr>
                    </thead>
                    <tbody>
            `;

        timeSlots.forEach(timeSlot => {
            scheduleHTML += `<tr><td class="time-cell">${timeSlot}</td>`;

            weekDays.forEach(day => {
                const lessonsInSlot = myLessons.filter(lesson =>
                    lesson.duration && lesson.duration.includes(day) &&
                    lesson.duration.includes(timeSlot)
                );

                if (lessonsInSlot.length > 0) {
                    scheduleHTML += `<td>`;
                    lessonsInSlot.forEach(lesson => {
                        scheduleHTML += `
                                <div class="lesson-cell">
                                    <strong>${lesson.name}</strong><br/>
                                    ${lesson.code}<br/>
                                    ${lesson.location || ''}
                                </div>
                            `;
                    });
                    scheduleHTML += `</td>`;
                } else {
                    scheduleHTML += `<td></td>`;
                }
            });

            scheduleHTML += `</tr>`;
        });

        scheduleHTML += `</tbody></table>`;

        if (myLessons.length === 0) {
            scheduleHTML = '<p>暂无课程安排</p>';
        }

        scheduleContainer.innerHTML = scheduleHTML;
        scheduleModal.style.display = 'block';
    }

    function logout() {
        Auth.clearTokens();
        window.location.href = '/login';
    }

    // 暴露函数到全局
    window.dropLesson = dropLesson;
    window.changePage = changePage;
    window.viewSchedule = viewSchedule;
    window.logout = logout;
</script>
</body>
</html>